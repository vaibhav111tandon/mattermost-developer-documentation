<!DOCTYPE html>





<html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> Improving performance (and more) through load testing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">   
<meta http-equiv="content-language" content="en-us" />



<link rel="canonical" href="https://mattermost.com/blog/improving-performance-through-load-testing/">


<link rel="shortcut icon" type="image/png" href="../../img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/tabs.css">
<link rel="stylesheet" href="../../css/bar.css">
<link rel="stylesheet" href="../../css/styles.css">
<link rel="stylesheet" href="../../css/code.css">
<link rel="stylesheet" href="../../css/note.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../../js/tabs.js"></script>
<script src="../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="//cdn.bizible.com/scripts/bizible.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-64458817-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-64458817-2');
</script>


<script type="text/javascript">
    (function() {
    var didInit = false;
    function initMunchkin() {
    if(didInit === false) {
    didInit = true;
    Munchkin.init('161-FBE-733');
    }
    }
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
    initMunchkin();
    }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>


<script type="text/javascript" charset="utf-8">
    var _eiq = _eiq || [];
    var _engagio_settings = {
      accountId: "cb6a404b72e9141b70d1f82abc04db92b4e56238"
    };
    (function() {
      var ei = document.createElement('script'); ei.type = 'text/javascript'; ei.async = true;
      ei.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'web-analytics.engagio.com/js/ei.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ei, s);
    })();
  </script>

</head>

<body class="blog-single">
    
<header class="with-notification-bar">

    <a href="../../"><img src="../../img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="../../">Home</a></li>
        
            
            
            
                
                    <li><a href="../../contribute/getting-started">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../integrate/getting-started">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../extend/getting-started">Extend</a></li>
                
            
        
            
            
            
                
                    <li class="active"><a href="../../blog">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>


<div class='notification-bar sticky-top'>
    <div class="notification-bar__content">
        <a class="notification-bar__close">
            <span aria-hidden="true">Ã—</span>
        </a>
        <a href="https://mattermost.com/careers">
            We&#39;re hiring!
        </a>
    </div>
</div>




    <div class="container">
        <div class="row">
            <div class="col-md-9 doc-content">
                <div class="well well-sm">
                    <div class="blog-item__header">
                        <div class="blog-item__title">Improving performance (and more) through load testing<br> <small></small></div>
                        <div class="blog-item__info">
                            September 7, 2020
                            <small class="blog-item__count">1029 words</small>
                        </div>
                    </div>
                    <hr>
                    <p>Have you ever wondered how many active users your application can handle at the same time? If so, you&rsquo;re not alone. Here at Mattermost we&rsquo;re building a highly concurrent messaging platform for team collaboration that needs to potentially serve up to several thousands of users simultaneously.</p>
<p>While standard functional testing (e.g. unit tests) is critical to verify correct behavior of your application, it&rsquo;s usually not sufficient to guarantee its performance at scale. This is where some form of performance testing can be particularly useful. Benchmarks do a good job at measuring the performance impact of single functions or limited portions of a codebase, but they can&rsquo;t capture how an application is going to perform as a whole under real-world conditions. To achieve this you need <strong>load testing</strong>.</p>
<h2 id="what-is-load-testing">What is load testing?&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#what-is-load-testing"></i></a> </h2>
<p>Load testing is the process of applying a certain amount of load to a target system in order to understand how it behaves.
The more realistic the generated load is, the more accurate and insightful the final results will be.</p>
<h2 id="why-does-it-matter">Why does it matter?&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#why-does-it-matter"></i></a> </h2>
<p>Load testing can be used to improve both the performance and the overall quality of your application by helping you to:</p>
<ul>
<li>Identify performance bottlenecks in your system.</li>
<li>Determine the overall capacity of your application.</li>
<li>Prevent performance regressions between releases.</li>
<li>Discover insidious bugs that passed functional testing.</li>
</ul>
<p>As an example, these are some of non-performance related, but rather significant issues we&rsquo;ve been able to detect while load testing:</p>
<ul>
<li>Data races</li>
<li>Application crashes</li>
<li>Deadlocks</li>
<li>Memory leaks</li>
</ul>
<p>As you can see, running load tests can guard your software against problems of different nature. By simulating users you get a chance to realistically test a system before it hits production and potentially avoid several issues down the line.</p>
<h2 id="how-are-we-doing-it">How are we doing it?&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#how-are-we-doing-it"></i></a> </h2>
<p>There are plenty of high quality load testing frameworks available; some of the best are free and open source (<a href="https://jmeter.apache.org/">JMeter</a>, <a href="https://gatling.io/">Gatling</a>, <a href="https://k6.io/">k6</a> to name a few). In our case, after a thorough examination, we decided to develop a custom, in-house tool. We accepted trading implementation time and complexity for improved simulation and finer control over the entire process. We&rsquo;ve recently released <a href="https://github.com/mattermost/mattermost-load-test-ng/releases/tag/v1.0.0">version 1.0</a> and we&rsquo;re quite happy with the choice we made. While the tool itself is not designed for general purpose use, it can still serve as a good example of how we tackled the problem of designing and developing a custom load testing engine.</p>
<h3 id="simulating-the-load">Simulating the load&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#simulating-the-load"></i></a> </h3>
<p>As the definition says, the core of the process is load generation. It&rsquo;s important to note that, similarly to what happens in other tools of this kind, the load will be generated at the HTTP (and Websocket) level through a series of API calls. This means that, from a performance perspective, we&rsquo;re going to be testing everything in between the user (client) and the physical machine running our target application (server). Furthermore, in order for results to be meaningful, we need the software to mimic actual user behavior. We achieve this by leveraging data coming from real users through the use of:</p>
<ul>
<li>Server-side metrics (e.g. frequency of a given API call)</li>
<li>User telemetry data (e.g. frequency of a user event/action)</li>
</ul>
<p>Fortunately, here at Mattermost we have a convenient advantage: we use our own application in our day-to-day work. This means we&rsquo;re able to continuously collect a considerable amount of realistic metrics from our community servers. We can then use such data to model user behavior. To do this we create a table of a user&rsquo;s actions with their respective frequencies. This action-frequency map will feed the simulation process: a simulated user will randomly pick and perform an action based on its frequency so that the most common actions will be picked more often.</p>
<p><img src="../../blog/2020-09-07-improving-performance-through-load-testing/actions-map.png" alt="actions-map"></p>
<p>In such an example, the chance of a user switching a channel will be double the chance of creating a new post and four times that of replying to a thread.</p>
<h3 id="getting-some-answers">Getting some answers&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#getting-some-answers"></i></a> </h3>
<p>Now that we have a simulation in place, we come back to the original question of this blog post: how can we make our load testing software tell us how many concurrently active users our target application can support?</p>
<p>Instead of relying on <a href="https://en.wikipedia.org/wiki/Magic_number_(programming)">magic formulas</a> which are hard to explain (and sometime defend) or on endless and error-prone manual testing, we thought of picking an idea out of <a href="https://en.wikipedia.org/wiki/Control_theory">control theory</a> that could give us both automation and precision at the same time: it&rsquo;s called a <strong>feedback loop</strong>.</p>
<p><img src="../../blog/2020-09-07-improving-performance-through-load-testing/feedback-loop.png" alt="feedback-loop"></p>
<p>The idea is quite simple: have the load testing engine react to what&rsquo;s happening on the target system by dynamically changing the amount of load applied in response to some event. This is achieved through the monitoring of those metrics that can best signal service degradation. Some that we make use of are:</p>
<ul>
<li>Request durations (average and percentiles)</li>
<li>Request errors rate</li>
<li>Client timeouts rate</li>
</ul>
<p><img src="../../blog/2020-09-07-improving-performance-through-load-testing/graph.png" alt="graph"></p>
<p>The load testing software constantly increases the number of active users up until it detects signs of performance degradation. This happens when the metrics being monitored reach their configured thresholds (e.g. 100ms for average request duration).
In response to such an event, the load testing engine starts to lower the number of users. This process continues for a while until an <strong>equilibrium point</strong> is reached. This value, over which performance starts to degrade, gives us a fairly good estimate on the user capacity our target application can comfortably support.</p>
<h2 id="wrapping-up">Wrapping up&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#wrapping-up"></i></a> </h2>
<p>The success of a software system greatly depends on its performance, especially in today&rsquo;s cloud-oriented world. A small outage can have a serious impact on your customers and eventually affect your company&rsquo;s revenue, especially when a <a href="https://en.wikipedia.org/wiki/Service_level_agreement">service level agreement</a> is in place.</p>
<p>Load testing is a precious tool that can help your team to improve both the overall quality and stability of your system by preventing performance issues and application bugs while improving scalability and minimizing the risk of down times.</p>
<p>Stay tuned for a follow-up article including an in depth technical discussion on the internals of our custom engine plus a full section on how to interpret and leverage load testing results.
If you&rsquo;d like to know more about this particular topic or discuss performance in general, you can reach us in the <a href="https://community.mattermost.com/core/channels/developers-performance">Developers: Performance</a> channel.</p>


                    <hr>
                    
                    Written by
                    
                    Claudio Costa
-
<a href="https://community.mattermost.com/core/messages/@claudio.costa" target="_blank">
    @claudio.costa
</a>
on
<a href="https://community.mattermost.com/signup_user_complete" target="_blank">
    community.mattermost.com
</a>
and
<a href="https://github.com/streamer45" target="_blank">
    @streamer45
</a>
on GitHub

                    
                    
                    <br />
                    <br />
                    Join us on <a href="https://community.mattermost.com/signup_user_complete"
                        target="_blank">community.mattermost.com</a>!
                </div>
            </div>

            
            <div class="col-md-3 doc-content tags-sidebar">
                <div class="well well-sm">

                    


                    <h6>Other Posts</h6>
                    <ul class="list-unstyled">
                        
                        
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/automated-ui-testing-with-cypress/">Automated UI Testing With Cypress</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/pritunl/">From OpenVPN to Pritunl VPN: The transition</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/open-tracing/">OpenTracing for Go Projects</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/hands-on-iouring-go/">Getting Hands-on with io_uring using Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/advanced-git-tbilisi-free-university/">Advanced Git with the Free University of Tbilisi</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/all-about-emojis/">All About Emojis</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/maintaining-consistency-in-codebases-with-go-vet/">Maintaining Consistency in Codebases with Go vet</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/instrumenting-go-code-via-ast-2/">Instrumenting Go code via AST, Part 2</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/layered-store-and-struct-embedding/">Layered Store and Struct Embedding in Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/incorporating-golangci-lint/">Incorporating GolangCI-Lint at Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/on-hermes-and-mattermost/">On Hermes and Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/onboarding-with-mattermost/">Onboarding with Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/kubecon-na-2019/">KubeCon NA 2019</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-center">
    <div class="container-fluid">
        <div class="footer__copyright">Â© Mattermost, Inc. All Rights Reserved.</div>
        <div class="footer__icons">
            <a href="https://www.facebook.com/Mattermost-2300985916642531/"><i class="fa fa-facebook"></i></a>
            <a href="https://twitter.com/mattermost"><i class="fa fa-twitter"></i></a>
            <a href="https://www.youtube.com/channel/UCNR05H72hi692y01bWaFXNA"><i class="fa fa-youtube"></i></a>
        </div>
    </div>
</footer>

</body>

</html>
